<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="../css/style_dash.css" />
  <link rel="website icon" type="png" href="./assets/imgs/logo2.png">
  <script src="./js/sessao.js"></script>

</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

   
<body onload="validarSessao(); buscarTipo(); kpi4(selectTemp); kpi4(selectUmi) ">
  <script src="https://kit.fontawesome.com/88fed8b646.js" crossorigin="anonymous"></script>
  <div class="container_all">
    <div class="container_menu">
      <ul class="lista">
        <li>
          <a href="landing_page.html"><img src="./assets/imgs/logo2.png" />
          </a>
        </li>
        <li>
          <a href="dashboard.html"><button style="font-weight: 700;">DASH</button></a>
        </li>
        <li>
          <a href="cadastro_funcionario.html"><button>CADASTRO</button></a>
        </li>
        <li>
          <a href="cadastro_lote.html"><button>ADICIONAR LOTE</button></a>
        </li>
        <li>
          <a href="atualizar_lote.html"><button>ATUALIZAR LOTE</button></a>
        </li>
        <li>
          <a href="suporte.html"><button>SUPORTE</button></a>
        </li>
        <li>
          <a href="login.html"><button>SAIR</button></a>
        </li>
      </ul>
    </div>
    <div class="container_dash">
      <div class="div_nav_dash border">
        <div class="bem_vindo">
          <span>Bem-vindo <span id="b_usuario"></span>!</span>
        </div>
        <i class="fa-solid fa-user icone_entrar"></i>
      </div>
      <div class="div_titulo">
        <h1>Informações sobre Linha de Produção</h1>
        <span class="span_filtro"><select name="" id="select_filtro" onclick=" filtro(); kpi1_2Lotes(); kpi_3tempLote(); kpi_3umidLote(); buscarUmidTempDiaLote(); buscarUmidTempMesLote()">
            <option value="todos" selected>Todos Lotes</option>
            <option value="lotes">Lotes individuais</option>
          </select></span>
        <span class="span_filtro_lote"><select name="" id="select_filtro_lote">
          </select></span>
      </div>
      </select></span>
      <div class="container_dashboard">
        <div class="dashboard border">
          <div class="container_kpis" id="container_kpis_sensores">
            <span class="kpis">
              <div class="informacao">
                <span class="titulos-kpis">Média de umidade diária:</span>
                <div class="container_valor_termometro">
                  <span id="UmidadePorcentagem3" class="info-kpi" style="color: rgb(48, 107, 196);"></span>
                  <div class="container_umidade">
                    <div class="umidade" id="umidade3">
                    </div>
                  </div>
                </div>
              </div>
            </span>

            <span class="kpis">
              <div class="informacao">
                <span class="titulos-kpis">Média de temperatura diária:</span>
                <div class="container_valor_termometro">
                  <span id="TemperaturaGraus" class="info-kpi" style="color: rgb(196, 169, 48);"></span>
                  <div class="container_termometro">
                    <div class="termometro" id="termometro">
                    </div>
                  </div>

                </div>
              </div>
            </span>
            <span class="kpis">
              <span class="titulos-kpis"> Horários de maior variação: </span>
              <div>
                <span class="info-kpi" id="kpi_3umidade" style=" font-size: 4vh; color: rgb(48, 107, 196)"></span> |
                <span class="info-kpi" id="kpi_3temperatura" style="font-size: 4vh; color:rgb(196, 169, 48)"></span> 
              </div>
            </span>
            <span class="kpis">
              <span class="titulos-kpis"> Maior variação comparado com a média:</span>
              <span class="info-kpi"> <span style="font-size: 4vh;" id="kpi_4temp"></span>
                <span style="color: black; font-size: 4vh;">|</span>
                <span style="color: blue; font-size: 4vh;" id="kpi_4umid"></span>
              </span>
            </span>
          </div>
          <span id="kpis_lotes">
            <div class="container_kpis_lote" id="container_kpis_lote">
              <span class="kpis">
                <div class="informacao">
                  <span class="titulos-kpis">Média de umidade diária:</span>
                  <div class="container_valor_termometro">
                    <span id="UmidadePorcentagem2" class="info-kpi" style="color: rgb(48, 107, 196);"></span>
                    <div class="container_umidade">
                      <div class="umidade" id="umidade2">
                      </div>
                    </div>
                  </div>
                </div>
              </span>
              <span class="kpis"> 
                <div class="informacao">
                  <span class="titulos-kpis">Média de temperatura diária:</span>
                  <div class="container_valor_termometro">
                    <span id="TemperaturaGraus2" class="info-kpi" style="color: rgb(196, 169, 48);"></span>
                    <div class="container_termometro">
                      <div class="termometro" id="termometro2">
                      </div>
                    </div>
                  </div>
                </div>
              </span>
            
              <span class="kpis">
                <span class="titulos-kpis"> Horários de maior variação: </span>
                <div>
                  <span id="kpi3Lotetemp" class="info-kpi" style="font-size: 4vh; color:rgb(196, 169, 48)"></span> | 
                  <span id="kpi3Loteumid" class="info-kpi" style=" font-size: 4vh; color: rgb(48, 107, 196)"></span>
                </div>
              </span>
          </span>
          <span class="kpis">
            <span class="titulos-kpis"> Quadrante que mais emitiu alertas:</span>
            <span class="info-kpi" style="font-size: 4vh;" id="kpi4_lotes"></span>
          </span>
        </div>
        </span>
        <div class="container_graficos">
        <div id="graficos_todos" class="graficos_todos">
          <div class="graficos border">
            <h1>Temperatura e Umidade diária</h1>
            <canvas class="chart" id="myChart2"></canvas>
          </div>
          <div class="graficos border">
            <h1>Temperatura e Umidade média mensal</h1>
            <canvas class="chart" id="myChart"></canvas>
          </div>
        </div>
      </div>

      <div id="grafico_tipo" class="graficos_border">
        <h1>Tipos por Lote</h1>
        <canvas class="chart" id="myChart_tipo"></canvas>
      </div>

        <span id="graficos_lotes">
          <div class="graficos border">
            <h1>Temperatura e Umidade da Última Hora</h1>
            <canvas class="chart" id="myChart2_lote"></canvas>
          </div> <br>
          <div class="graficos border">
            <h1>Temperatura e Umidade média mensal</h1>
            <canvas class="chart" id="myChart_lote"></canvas>
          </div>
        </span>
       
      </div>
    </div>

    <div class="legenda border">
      <h3>Parâmetros</h3>
      <span>Margem ideal de temperatura: <b>18°C a 26°C</b></span> <br>
      <span>Margem ideal de umidade: <b>75% a 100%</b></span>
    </div>

  </div>

  </div>
</body>

</html>
<script>
  var selectTemp = "temperatura"
  var selectUmi = "umidade"

  var mediaUmidadeTS = 0
  var mediaTempTS = 0
  listar()
  kpi1_2()
  kpi_3temp()
  kpi_3umid()
  buscarUmidTempDia()
  buscarUmidTempMes()
  var filtroSelect = document.getElementById("select_filtro_lote")
  filtroSelect.addEventListener('change',atualizarLotesIndividuais)
  function atualizarLotesIndividuais(){
    filtro(); kpi1_2Lotes(); kpi_3tempLote(); kpi_3umidLote(); buscarUmidTempDiaLote(); buscarUmidTempMesLote(); 
  }
  setInterval(() => {
    kpi1_2()
    kpi_3temp()
    kpi_3umid()
    buscarUmidTempDia()
    buscarUmidTempMes()
    buscarUmidTempDiaLote()
    kpi4("temperatura")
    kpi4("umidade")
  }, 20000)


  document.getElementById("select_filtro_lote").style.display = "none";
  document.getElementById("container_kpis_sensores").style.display = "flex";
  document.getElementById("container_kpis_lote").style.display = "none";
  document.getElementById("graficos_lotes").style.display = 'none'
  document.getElementById("graficos_todos").style.display = 'flex';
  function filtro() {
    if (select_filtro.value == 'lotes') {
      document.getElementById("graficos_lotes").style.display = 'flex'
      document.getElementById("select_filtro_lote").style.display = "flex";
      document.getElementById("container_kpis_sensores").style.display = "none";
      document.getElementById("container_kpis_lote").style.display = "flex";
      document.getElementById("graficos_todos").style.display = 'none';
      document.getElementById("grafico_tipo").style.display = 'none';
      kpi1_2Lotes()
    }
    else if (select_filtro.value == 'todos') {
      document.getElementById("select_filtro_lote").style.display = "none";
      document.getElementById("container_kpis_sensores").style.display = "flex";
      document.getElementById("container_kpis_lote").style.display = "none";
      document.getElementById("graficos_lotes").style.display = 'none'
      document.getElementById("graficos_todos").style.display = 'flex';
      document.getElementById("grafico_tipo").style.display = 'flex';
      kpi1_2()
    }
  }


  const ctx = document.getElementById("myChart");
  const ctx_lote = document.getElementById("myChart_lote")
  const ctx2_lote = document.getElementById("myChart2_lote")
  const ctx2 = document.getElementById("myChart2");
  
  function kpi4(tipo){
    fetch(`/lotes/kpi4_geral/${tipo}`, {
      method: "GET"
    }).then(response =>{
      if (response.ok) {
        response.json().then(json =>{
          kpi4_lotes.innerHTML = `Quadrante: ${json[0].quadrante}`
        })
      } else {
        console.error('Erro ao obter dados por quadrante');
      }
    })
  }


  let myChart;
  function buscarUmidTempDia() {
    fetch("/lotes/buscarUmidTempDia", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA
      })
    }).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        console.error('Erro ao obter dados do gráfico');
      }
    })
      .then(data => {
        if (data && data.length > 0) {
          // processa os dados e plota o grafico
          var labels = [];
          var valuesTemp = [];
          var valuesUmid = [];

          for (var i = 0; i < data.length; i++) {
            labels.push(Number(data[i].horario));
            valuesTemp.push(Number(data[i].mediaTemp));
            valuesUmid.push(Number(data[i].mediaUmid))
          }
          if (myChart) {
        myChart.destroy();
      }
          myChart = new Chart(ctx2, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Temperatura",
                  data: valuesTemp,
                  borderWidth: 2,
                  borderColor: "#ff5927",
                  backgroundColor: "#ff5927",
                },
                {
                  label: "Umidade",
                  data: valuesUmid,
                  borderWidth: 2,
                  borderColor: "#45aadd",
                  backgroundColor: "#45aadd",
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });

        }
      })
      .catch(error => {
        console.error('Erro ao obter dados do gráfico:', error);
      });
  }

  let myCHartUMidTemp;
  function buscarUmidTempMes() {
    fetch("/lotes/buscarUmidTempMes", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA
      })
    }).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        console.error('Erro ao obter dados do gráfico');
      }
    })
      .then(data => {
        if (data && data.length > 0) {
          // processa os dados e plota o grafico
          var listaMeses = [];
          var listaTemp = [];
          var listaUmid = [];

          for (var i = 0; i < data.length; i++) {
            listaMeses.push(Number(data[i].mes));
            listaTemp.push(Number(data[i].mediaTemp));
            listaUmid.push(Number(data[i].mediaUmid))
          }
          if (myCHartUMidTemp) {
            myCHartUMidTemp.destroy();
           }
           myCHartUMidTemp = new Chart(ctx, {
            type: "bar",
            data: {
              labels: listaMeses,
              datasets: [
                {
                  label: "Temperatura Média",
                  data: listaTemp,
                  borderWidth: 1,
                  borderColor: "#ff5927",
                  backgroundColor: "#ff5927",
                },
                {
                  label: "Umidade Média",
                  data: listaUmid,
                  borderWidth: 1,
                  borderColor: "#45aadd",
                  backgroundColor: "#45aadd",
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });

        }
      })
      .catch(error => {
        console.error('Erro ao obter dados do gráfico:', error);
      });
  } 

  var listaTipo = []
  var listaQtd = []
 
  let myChartTipo;
  function buscarTipo(){
    var fkEmpresa = sessionStorage.FK_EMPRESA
    fetch(`/lotes/buscarTipo/${fkEmpresa}`, {
      method: "GET"
    }).then(response =>{
      if (response.ok) {
        response.json().then(json =>{
          for (let i = 0; i < json.length; i++) {
            listaQtd.push(json[i].qtdTipo)
            listaTipo.push(json[i].tipo)
    const ctx2_tipo = document.getElementById(`myChart_tipo`)
    if (myChartTipo) {
      myChartTipo.destroy();
           }
    myChartTipo = new Chart(ctx2_tipo, {
    type: "doughnut",
    data: {
      labels: listaTipo,
      datasets: [
        {
          label: "Tipos por lote",
          data: listaQtd,
          borderWidth: 2,
          borderColor: ["#815f32", '#DAA520'],
          backgroundColor: ["#815f32", '#DAA520']
        },
       
      ],
    },
  });
          }
        })
      } else {
        console.error('Erro ao obter dados por quadrante');
      }
    })

   
  }


  var labelsHORA = []
  var dataumidHORA = []
  var datatempHORA = [] 

  var fkLoteantigo = null
  let myChartTempUmidLote
  function buscarUmidTempDiaLote(){
    var fkLote = Number(select_filtro_lote.value)
    if (fkLoteantigo != fkLOte) {
      fkLoteantigo = fkLote;
      myChartTempUmidLote.destroy()
    } 
    var fkEmpresa = sessionStorage.FK_EMPRESA
    labelsHORA = []
    dataumidHORA = []
    datatempHORA = [] 
    fetch(`/lotes/buscarUmidTempDiaLote/${fkEmpresa}/${fkLote}`, {
      method: "GET"
    }).then(response =>{
      if (response.ok) {
        response.json().then(json =>{
          for(i = 0; i < json.length; i++){
            console.log(json[i].horarioCaptura)
            json[i].horarioCaptura = json[i].horarioCaptura.slice(11,-5)
            console.log(json[i].horarioCaptura)
            labelsHORA.push(json[i].horarioCaptura)
            dataumidHORA.push(json[i].umidade)
            datatempHORA.push(json[i].temperatura)
          }

  
    if (myChartTempUmidLote) {
      if(myChartTempUmidLote.data.datasets[0].data.length < 15){
        console.log(myChartTempUmidLote.data.datasets[0].data.length)
      myChartTempUmidLote.data.labels.push(labelsHORA[labelsHORA.length-1]);
      myChartTempUmidLote.data.datasets[0].data.push(datatempHORA[datatempHORA.length -1]);
      myChartTempUmidLote.data.datasets[1].data.push(dataumidHORA[dataumidHORA.length -1]);
      }
      else{
        myChartTempUmidLote.data.labels.shift();
      myChartTempUmidLote.data.labels.push(labelsHORA[labelsHORA.length-1]);
      myChartTempUmidLote.data.datasets[0].data.shift();  
      myChartTempUmidLote.data.datasets[0].data.push(datatempHORA[datatempHORA.length -1]);
      myChartTempUmidLote.data.datasets[1].data.shift();  
      myChartTempUmidLote.data.datasets[1].data.push(dataumidHORA[dataumidHORA.length -1]);
      }
      myChartTempUmidLote.update();
    } else{
      myChartTempUmidLote = new Chart(ctx2_lote, {
      type: "line",
      data: {
      labels: labelsHORA,
      datasets: [
        {
          label: "Temperatura", 
          data: datatempHORA,
          borderWidth: 2,
          borderColor: "#ff5927",
          backgroundColor: "#ff5927",
        },
        {
          label: "Umidade",
          data: dataumidHORA,
          borderWidth: 2,
          borderColor: "#45aadd",
          backgroundColor: "#45aadd",
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });
    }
        })
      } else {
        console.error('Erro ao obter dados por horario');
      }
    })
  }

  let myChartTempUmidLote2
     
  function buscarUmidTempMesLote() {
    var fkLote = Number(select_filtro_lote.value)
    var fkEmpresa =  sessionStorage.FK_EMPRESA
    fetch(`/lotes/buscarUmidTempMesLote/${fkEmpresa}/${fkLote}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      },
    }).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        console.error('Erro ao obter dados do gráfico');
      }
    })
      .then(data => {
        var labels = [];
        var valuesTemp = [];
        var valuesUmid = [];  

          for (var i = 0; i < data.length; i++) {
            labels.push(Number(data[i].mes));
            valuesTemp.push(Number(data[i].mediaTemp));
            valuesUmid.push(Number(data[i].mediaUmid))
          }
          if (myChartTempUmidLote2) {
            myChartTempUmidLote2.destroy();
      }
           myChartTempUmidLote2 = new Chart(ctx_lote, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Temperatura Média",
                  data: valuesTemp,
                  borderWidth: 1,
                  borderColor: "#ff5927",
                  backgroundColor: "#ff5927",
                },
                {
                  label: "Umidade Média",
                  data: valuesUmid,
                  borderWidth: 1,
                  borderColor: "#45aadd",
                  backgroundColor: "#45aadd",
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });

        
      })
      .catch(error => {
        console.error('Erro ao obter dados do gráfico:', error);
      });
  } 


  function kpi1_2() {
    fetch("/lotes/kpi1_2", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA
      })
    }).then((res => {
      res.json().then((json) => {
        mediaTempTS = Number(json[0].mediaTempDiaria)
        mediaUmidadeTS = Number(json[0].mediaUmidDiaria)


        const termometroTemp = document.getElementById("termometro")
        termometroTemp.style.height = mediaTempTS * 2 + "%";
        TemperaturaGraus.innerHTML = `${mediaTempTS.toFixed(1)}°C`
        if (mediaTempTS > 26 || mediaTempTS < 18) {
          termometroTemp.style.backgroundColor = '#ff0000';
          termometroTemp.style.boxShadow = '3px 3px 10px #ff0000';
          TemperaturaGraus.innerHTML = ` ${mediaTempTS.toFixed(1)}°C <img src="./assets/imgs/alerta.png" width= '35px'> </img>`;
        }

        const termometroUmidade3 = document.getElementById("umidade3")
        termometroUmidade3.style.height = mediaUmidadeTS + "%";
        UmidadePorcentagem3.innerHTML = `${mediaUmidadeTS.toFixed(1)}%`;
        if (mediaUmidadeTS < 75) {
          termometroUmidade3.style.backgroundColor = '#ff0000';
          termometroUmidade3.style.boxShadow = '3px 3px 10px #ff0000';
          UmidadePorcentagem3.innerHTML = ` ${mediaUmidadeTS.toFixed(1)}% <img src="./assets/imgs/alerta.png" width= '35px'> </img> `;
        }

      })
    }))
  };

  function kpi_3temp() {
    fetch("/lotes/kpi_3temp", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA
      })
    }).then((res => {
      res.json().then((json) => {
        kpi_3temperatura.innerHTML = `${json[0].horaTemp}:00`;
        kpi_4temp.innerHTML = `${json[0].variacao_temperaturaFINAL}°C`;
      })
    }))
  }

  function kpi_3umid() {
    fetch("/lotes/kpi_3umid", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA
      })
    }).then((res => {
      res.json().then((json) => {
        kpi_3umidade.innerHTML = `${json[0].horaUmid}:00`;
        kpi_4umid.innerHTML = `${json[0].variacao_umidadeFINAL}%`;
      })
    }))
  }

  function listar() {
    fetch("/lotes/listar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA
      })
    }).then((res => {
      res.json().then((json) => {
        lote = json

        for (var i = 0; i < lote.length; i++) {
          select_filtro_lote.innerHTML += `<option value="${lote[i].idLote}" > Lote ${lote[i].estufa}</option>`
        }
      })
    }))
  }

  function kpi1_2Lotes() {
    const select = document.getElementById('select_filtro_lote');
    const loteSelecionado = select.value;
    fetch("/lotes/kpi1_2Lotes", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA,
        idLoteServer: loteSelecionado
      })
    }).then((res => {
      res.json().then((json) => {

        mediaTempTS = Number(json[0].mediaTempDiariaLote)
        mediaUmidadeTS = Number(json[0].mediaUmidDiariaLote)

        const termometroTemp2 = document.getElementById("termometro2")
        termometroTemp2.style.height = mediaTempTS * 2 + "%";
        TemperaturaGraus2.innerHTML = `${mediaTempTS.toFixed(1)}C°`;
        if (mediaTempTS > 26 || mediaTempTS < 18) {
          termometroTemp2.style.backgroundColor = '#ff0000';
          termometroTemp2.style.boxShadow = '3px 3px 10px #ff0000';
          TemperaturaGraus2.innerHTML = ` ${mediaTempTS.toFixed(1)}°C <img src="./assets/imgs/alerta.png" width= '35px'> </img>`;
        }

        const termometroUmidade3 = document.getElementById("umidade2")
        termometroUmidade3.style.height = mediaUmidadeTS + "%";
        UmidadePorcentagem2.innerHTML = `${mediaUmidadeTS.toFixed(1)}%`;
        if (mediaUmidadeTS < 75) {
          termometroUmidade3.style.backgroundColor = '#ff0000';
          termometroUmidade3.style.boxShadow = '3px 3px 10px #ff0000';
          UmidadePorcentagem2.innerHTML = ` ${mediaUmidadeTS.toFixed(1)}% <img src="./assets/imgs/alerta.png" width= '35px'> </img> `;
        }
      })
    }))
  }

  
  function kpi_3tempLote() {
    const select = document.getElementById('select_filtro_lote');
    const loteSelecionado = select.value;
    fetch("/lotes/kpi_3temp", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA,
        idLoteServer: loteSelecionado
      })
    }).then((res => {
      res.json().then((json) => {
        kpi3Lotetemp.innerHTML = `${json[0].horaTemp}:00`;
        
      })
    }))}


    function kpi_3umidLote() {
      const select = document.getElementById('select_filtro_lote');
      const loteSelecionado = select.value;
    fetch("/lotes/kpi_3umidLote", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkempresaServer: sessionStorage.FK_EMPRESA,
        idLoteServer: loteSelecionado
      })
    }).then((res => {
      res.json().then((json) => {
        kpi3Loteumid.innerHTML = `${json[0].horaUmid}:00`;
      })
    }))
  }

</script>