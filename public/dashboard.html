  <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="../css/style_dash.css" />
  <link rel="website icon" type="png" href="./assets/imgs/logo2.png">
  <script src="./js/sessao.js"></script>

</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body onload="validarSessao()">
  <script src="https://kit.fontawesome.com/88fed8b646.js" crossorigin="anonymous"></script>
  <div class="container_all">
    <div class="container_menu">
      <ul class="lista">
        <li>
          <a href="landing_page.html"
            ><img src="./assets/imgs/logo2.png" />
          </a>
        </li>
        <li>
          <a href="dashboard.html"><button style="font-weight: 700;">DASH</button></a>
        </li>
        <li>
          <a href="cadastro_funcionario.html"
            ><button>CADASTRO</button></a
          >
        </li>
        <li>
          <a href="cadastro_lote.html"
            ><button>ADICIONAR LOTE</button></a
          >
        </li>
        <li>
          <a href="atualizar_lote.html"
            ><button>ATUALIZAR LOTE</button></a
          >
        </li>
        <li>
          <a href="suporte.html"
            ><button>SUPORTE</button></a
          >
        </li>
        <li>
          <a href="login.html"><button>SAIR</button></a>
        </li>
      </ul>
    </div>
    <div class="container_dash">
      <div class="div_nav_dash border">
        <div class="bem_vindo">
          <span>Bem-vindo <span id="b_usuario"></span>!</span>
        </div>
        <i class="fa-solid fa-user icone_entrar"></i>
      </div>
      <div class="div_titulo">
        <h1>Informações sobre Linha de Produção</h1>
        <span class="span_filtro"><select name="" id="select_filtro" onclick="filtro()">
            <option value="todos" selected>Todos Lotes</option>
            <option value="lotes">Lotes individuais</option>
          </select></span>
          <span class="span_filtro_lote"><select name="" id="select_filtro_lote" onclick="filtro()">
          </select></span>
      </div>
      </select></span>
      <div class="container_dashboard">
        <div class="dashboard border">
          <div class="container_kpis" id="container_kpis_sensores">
            <span class="kpis">
              <div class="informacao">
                <span class="titulos-kpis">Média de umidade diária:</span>
                <div class="container_valor_termometro">
                  <span id="UmidadePorcentagem3" class="info-kpi" style="color: rgb(48, 107, 196);"></span>
                  <div class="container_umidade">
                    <div class="umidade" id="umidade3">
                    </div>
                  </div>
                </div>
              </div>
            </span>

            <span class="kpis">
              <div class="informacao">
                <span class="titulos-kpis">Média de temperatura diária:</span>
                <div class="container_valor_termometro">
                  <span id="TemperaturaGraus" class="info-kpi" style="color: rgb(196, 169, 48);"></span>
                  <div class="container_termometro">
                    <div class="termometro" id="termometro">
                    </div>
                  </div>

                </div>
              </div>
            </span>
            <span class="kpis">
              <span class="titulos-kpis"> Horários de maior variação: </span>
              <div>
                <span class="info-kpi" id="kpi_3temperatura" style="font-size: 4vh; color:rgb(196, 169, 48)"></span> | <span class="info-kpi" id="kpi_3umidade" style=" font-size: 4vh; color: rgb(48, 107, 196)"></span>
              </div>
            </span>
            <span class="kpis">
              <span class="titulos-kpis"> Maior variação comparado com a média:</span>
              <span class="info-kpi"> <span id="kpi_4temp">5ºC</span> 
                <span style="color: black;">|</span> 
                    <span style="color: blue;" id="kpi_4umid">10%</span>
              </span>
            </span>
          </div>
          <span id="kpis_lotes">
            <div class="container_kpis_lote" id="container_kpis_lote">
              <span class="kpis">
                <div class="informacao">
                  <span class="titulos-kpis">Média de umidade diária:</span>
                  <div class="container_valor_termometro">
                    <span id="UmidadePorcentagem2" class="info-kpi" style="color: rgb(48, 107, 196);"></span>
                    <div class="container_umidade">
                      <div class="umidade" id="umidade2">
                      </div>
                    </div>
                  </div>
                </div>
              </span>
              <span class="kpis">
                <div class="informacao">
                  <span class="titulos-kpis">Média de temperatura diária:</span>
                  <div class="container_valor_termometro">
                    <span id="TemperaturaGraus2" class="info-kpi" style="color: rgb(196, 169, 48);"></span>
                    <div class="container_termometro">
                      <div class="termometro" id="termometro2">
                      </div>
                    </div>
                  </div>
                </div>
              </span>
              <span class="kpis">
                <span class="titulos-kpis"> Horários de maior variação: </span>
              <div>
                <span class="info-kpi" style="font-size: 4vh; color:rgb(196, 169, 48)"></span> | <span class="info-kpi"  style=" font-size: 4vh; color: rgb(48, 107, 196)">13:00</span>
              </div>
            </span>
              </span>
              <span class="kpis">
                <span class="titulos-kpis"> Quadrante que mais emitiu alertas:</span>
                <span class="info-kpi" style="font-size: 5vh;">Quadrante 2</span>
              </span>
            </div>
          </span>
          <div id="graficos_todos" class="graficos_todos">
            <div class="graficos border">
              <h1>Temperatura e Umidade diária</h1>
              <canvas class="chart" id="myChart2"></canvas>
            </div>
            <div class="graficos border">
              <h1>Temperatura e Umidade média mensal</h1>
              <canvas class="chart" id="myChart"></canvas>
            </div>
          </div>
          <span id="graficos_lotes">
              <div class="graficos border">
                <h1>Temperatura e Umidade diária (Lote ABC123)</h1>
                <canvas class="chart" id="myChart2_lote"></canvas>
              </div>
              <div class="graficos border">
                <h1>Temperatura e Umidade média mensal (Lote ABC123)</h1>
                <canvas class="chart" id="myChart_lote"></canvas>
              </div>
          </span>
        </div>
      </div>
      
      <div class="legenda border">
        <h3>Parâmetros</h3>
        <span>Margem ideal de temperatura: <b>18°C a 26°C</b></span> <br>
        <span>Margem ideal de umidade: <b>75% a 100%</b></span>
      </div>

    </div>
    
  </div>
</body>

</html>
<script>
    var mediaUmidadeTS = 0
    var mediaTempTS = 0
    listar()
  kpi1_2()
  kpi_3temp()
  kpi_3umid()
  buscarUmidTempDia()
  buscarUmidTempMes()
  

  document.getElementById("select_filtro_lote").style.display = "none";
      document.getElementById("container_kpis_sensores").style.display = "flex";
      document.getElementById("container_kpis_lote").style.display = "none";
      document.getElementById("graficos_lotes").style.display = 'none'
      document.getElementById("graficos_todos").style.display = 'flex';
  function filtro() {
    if (select_filtro.value == 'lotes') {
      document.getElementById("graficos_lotes").style.display = 'flex'
      document.getElementById("select_filtro_lote").style.display = "flex";
      document.getElementById("container_kpis_sensores").style.display = "none";
      document.getElementById("container_kpis_lote").style.display = "flex";
      document.getElementById("graficos_todos").style.display = 'none';
    }
    else if (select_filtro.value == 'todos') {
      document.getElementById("select_filtro_lote").style.display = "none";
      document.getElementById("container_kpis_sensores").style.display = "flex";
      document.getElementById("container_kpis_lote").style.display = "none";
      document.getElementById("graficos_lotes").style.display = 'none'
      document.getElementById("graficos_todos").style.display = 'flex';
    }
  }

//   //Lote ABC123
//   var mediaUmidadeLote = 70
//   var mediaTempLote = 28

//   //Lote DEF456
//   var mediaUmidadeLote2 = Math.random();
//   mediaUmidadeLote2 = Math.floor(mediaUmidadeLote2 * 35 + 65 );
//   var mediaTempLote2 = Math.random();
//   mediaTempLote2 = Math.floor(mediaTempLote2 * 15 + 15 );

// // primeira kpi umidade (lote abc)
//   const termometroUmidade2 = document.getElementById("umidade2")
//   termometroUmidade2.style.height = mediaUmidadeLote + "%";
//   UmidadePorcentagem2.innerHTML = `${mediaUmidadeLote}%`;
//   if (mediaUmidadeLote < 75) {  
//     termometroUmidade2.style.backgroundColor = '#ff0000';
//     termometroUmidade2.style.boxShadow = '3px 3px 10px #ff0000';
//     UmidadePorcentagem2.innerHTML = ` ${mediaUmidadeLote}% <img src ='https://png.pngtree.com/png-clipart/20230504/original/pngtree-alert-flat-icon-png-image_9138397.png' width= '35px'> </img> `;
//   }
    
// // segunda kpi temperatura (lote abc)
//   const termometroTemp2 = document.getElementById("termometro2")
//   termometroTemp2.style.height = mediaTempLote*2 + "%";
//   TemperaturaGraus2.innerHTML = `${mediaTempLote}C°`;
//   if (mediaTempLote > 26 || mediaTempTS < 18) {
//     termometroTemp2.style.backgroundColor = '#ff0000';
//     termometroTemp2.style.boxShadow = '3px 3px 10px #ff0000';
//     TemperaturaGraus2.innerHTML = ` ${mediaTempLote}°C <img src ='https://png.pngtree.com/png-clipart/20230504/original/pngtree-alert-flat-icon-png-image_9138397.png' width= '35px'> </img>`;
//   }

//   // primeira kpi umidade (lote def)
//   const termometroUmidade4 = document.getElementById("umidade4")
//   termometroUmidade4.style.height = mediaUmidadeLote2 + "%";
//   UmidadePorcentagem4.innerHTML = `${mediaUmidadeLote2}%`;
//   if (mediaUmidadeLote2 < 75) {  
//     termometroUmidade4.style.backgroundColor = '#ff0000';
//     termometroUmidade4.style.boxShadow = '3px 3px 10px #ff0000';
//     UmidadePorcentagem4.innerHTML = ` ${mediaUmidadeLote2}% <img src ='https://png.pngtree.com/png-clipart/20230504/original/pngtree-alert-flat-icon-png-image_9138397.png' width= '35px'> </img> `;
//   }

//   // segunda kpi temperatura (lote def)
//   const termometroTemp4 = document.getElementById("termometro4")
//   termometroTemp4.style.height = mediaTempLote2*2 + "%";
//   TemperaturaGraus4.innerHTML = `${mediaTempLote2}ºC`;
//   if (mediaTempLote2 > 25 ) {
//     termometroTemp4.style.backgroundColor = '#ff0000';
//     termometroTemp4.style.boxShadow = '3px 3px 10px #ff0000';
//     TemperaturaGraus4.innerHTML = ` ${mediaTempLote2}°C <img src ='https://png.pngtree.com/png-clipart/20230504/original/pngtree-alert-flat-icon-png-image_9138397.png' width= '35px'> </img>`;
//   }

  const ctx = document.getElementById("myChart");
  const ctx2 = document.getElementById("myChart2");
  const ctx_lote = document.getElementById("myChart_lote")
  const ctx2_lote = document.getElementById("myChart2_lote")


  function buscarUmidTempDia() {
    fetch("/lotes/buscarUmidTempDia",{
    method: "POST",
      headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkempresaServer: sessionStorage.FK_EMPRESA
            })
          }).then(response => {
        if (response.ok) {
          return response.json();
          console.log(response)
        } else {
          console.error('Erro ao obter dados do gráfico');
        }
      })
      .then(data => {
        if (data && data.length > 0) {
          // processa os dados e plota o grafico
          var labels = [];
          var valuesTemp = [];
          var valuesUmid = [];

          for (var i = 0; i < data.length; i++) {
            labels.push(Number(data[i].horario));
            valuesTemp.push(Number(data[i].mediaTemp));
            valuesUmid.push(Number(data[i].mediaUmid))
          }
  new Chart(ctx2, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Temperatura",
          data: valuesTemp,
          borderWidth: 2,
          borderColor: "#ff5927",
          backgroundColor: "#ff5927",
        },
        {
          label: "Umidade",
          data: valuesUmid,
          borderWidth: 2,
          borderColor: "#45aadd",
          backgroundColor: "#45aadd",
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

        }
      })
      .catch(error => {
        console.error('Erro ao obter dados do gráfico:', error);
      });
  }

  function buscarUmidTempMes() {
    fetch("/lotes/buscarUmidTempMes",{
    method: "POST",
      headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkempresaServer: sessionStorage.FK_EMPRESA
            })
          }).then(response => {
        if (response.ok) {
          return response.json();
          console.log(response)
        } else {
          console.error('Erro ao obter dados do gráfico');
        }
      })
      .then(data => {
        if (data && data.length > 0) {
          // processa os dados e plota o grafico
          var labels = [];
          var valuesTemp = [];
          var valuesUmid = [];

          for (var i = 0; i < data.length; i++) {
            labels.push(Number(data[i].mes));
            valuesTemp.push(Number(data[i].mediaTemp));
            valuesUmid.push(Number(data[i].mediaUmid))
          }

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Temperatura Média",
          data: valuesTemp,
          borderWidth: 1,
          borderColor: "#ff5927",
          backgroundColor: "#ff5927",
        },
        {
          label: "Umidade Média",
          data: valuesUmid,
          borderWidth: 1,
          borderColor: "#45aadd",
          backgroundColor: "#45aadd",
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

}
      })
      .catch(error => {
        console.error('Erro ao obter dados do gráfico:', error);
      });
  }




  new Chart(ctx_lote, {
    type: "bar",
    data: {
      labels: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho"],
      datasets: [
        {
          label: "Temperatura Média",
          data: [22, 24, 24, 23, 17, 21],
          borderWidth: 1,
          borderColor: "#ff5927",
          backgroundColor: "#ff5927",
        },
        {
          label: "Umidade Média",
          data: [50, 55, 60, 57, 63, 55],
          borderWidth: 1,
          borderColor: "#45aadd",
          backgroundColor: "#45aadd",
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });
  new Chart(ctx2_lote, {
    type: "line",
    data: {
      labels: ["10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00"],
      datasets: [
        {
          label: "Temperatura",
          data: [35, 29, 28, 30, 32, 32, 30, 28, 27, 22, 21, 29],
          borderWidth: 2,
          borderColor: "#ff5927",
          backgroundColor: "#ff5927",
        },
        {
          label: "Umidade",
          data: [66, 68, 66, 61, 76, 79, 78, 74, 72, 66, 73],
          borderWidth: 2,
          borderColor: "#45aadd",
          backgroundColor: "#45aadd",
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  function kpi1_2(){
    fetch("/lotes/kpi1_2", {
      method: "POST",
      headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkempresaServer: sessionStorage.FK_EMPRESA
            })
    }).then((res => {
      res.json().then((json) => {
        console.log(json)
        mediaTempTS = Number(json[0].mediaTempDiaria)
        mediaUmidadeTS = Number(json[0].mediaUmidDiaria)


        const termometroTemp = document.getElementById("termometro")
        termometroTemp.style.height = mediaTempTS*2 + "%";
        TemperaturaGraus.innerHTML = `${mediaTempTS}°C`
        if (mediaTempTS > 26 || mediaTempTS < 18) {
            termometroTemp.style.backgroundColor = '#ff0000';
            termometroTemp.style.boxShadow = '3px 3px 10px #ff0000';
            TemperaturaGraus.innerHTML = ` ${mediaTempTS}°C <img src ='https://png.pngtree.com/png-clipart/20230504/original/pngtree-alert-flat-icon-png-image_9138397.png' width= '35px'> </img>`;
        }

        const termometroUmidade3 = document.getElementById("umidade3")
        termometroUmidade3.style.height = mediaUmidadeTS + "%";
        UmidadePorcentagem3.innerHTML = `${mediaUmidadeTS}%`;
        if (mediaUmidadeTS < 75) {
    termometroUmidade3.style.backgroundColor = '#ff0000';
    termometroUmidade3.style.boxShadow = '3px 3px 10px #ff0000';
    UmidadePorcentagem3.innerHTML = ` ${mediaUmidadeTS}% <img src ='https://png.pngtree.com/png-clipart/20230504/original/pngtree-alert-flat-icon-png-image_9138397.png' width= '35px'> </img> `;
  }

    })
  }))
  };

  function kpi_3temp(){
    fetch("/lotes/kpi_3temp", {
      method: "POST",
      headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkempresaServer: sessionStorage.FK_EMPRESA
            })
    }).then((res => {
      res.json().then((json) => {
        console.log(json)
        console.log(json[0].horaTemp)
        kpi_3temperatura.innerHTML = `${json[0].horaTemp}:00`;
        kpi_4temp.innerHTML = `${json[0].variacao_temperaturaFINAL}°C`;
    })
  }))
  }

  function kpi_3umid(){
    fetch("/lotes/kpi_3umid", {
      method: "POST",
      headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkempresaServer: sessionStorage.FK_EMPRESA
            })
    }).then((res => {
      res.json().then((json) => {
        console.log(json)
        console.log(json[0].horaUmid)
        kpi_3umidade.innerHTML = `${json[0].horaUmid}:00`;
        kpi_4umid.innerHTML = `${json[0].variacao_umidadeFINAL}%`;
    })
  }))
  }

  function listar(){
    fetch("/lotes/listar", {
      method: "POST",
      headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkempresaServer: sessionStorage.FK_EMPRESA
            })
    }).then((res => {
      res.json().then((json) => {
        console.log(json)
        lote = json
        console.log(lote)

        for(var i = 0; i < lote.length; i++){
          select_filtro_lote.innerHTML += `<option value="${lote[i].idLote}" > Lote ${lote[i].estufa}</option>`  
        }
    })
  }))
}
  

</script>